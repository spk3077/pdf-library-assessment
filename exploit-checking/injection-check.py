"""
File: injection-check.py
Assignment: MS Capstone
Lanuguage: python3
Author: Sean Kells <spk3077@rit.edu>
Purpose: Test generated PDFs for PDF Injection (PDF Injection & Image Escape)
"""
from os import listdir
from os.path import join, dirname

from PyPDF2 import PdfReader
from PyPDF2.errors import PdfStreamError, PdfReadError

DIR_TO_PDFS: str = "/../environments/tcpdf/php/pdfs"


def get_files() -> set:
    """
    get_files retrieves all the filenames of PDFs within the DIR_TO_PDFS directory

    :return: Set containing PDF file paths
    """
    ret: set = set()
    dir: str = dirname(__file__) + DIR_TO_PDFS

    for filename in listdir(dir):
        if filename == "README.md":
            continue

        ret.add(join(dir, filename))

    return ret


def check_pdf_valid(file_path: str) -> bool:
    """
    check_pdf_valid checks if the inputted file_path is a valid PDF

    :param file_path: the file_path 
    :return: True if input PDF is valid, false if invalid
    """
    try:
        with open(file_path, 'rb') as f:
            reader = PdfReader(f, True)
            page = reader.pages[0]
            if reader.metadata and page.extract_text().find("DOGTEST") != -1:
                return True
            else:
                return False
    except:
        return False


def main():
    """
    main is primary function when executing the Python script.

    :return: Nothing
    """
    files: set = get_files()

    count: int = 0
    for file in files:
        if not check_pdf_valid(file):
            print("The file, " + file[file.rfind('/') + 1:] + " was found to be invalid. Check for injection")
            count += 1

    if count == 0:
        print("No injections detected!")


if __name__ == "__main__":
    main()