package csec.pla.IText;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.nio.file.DirectoryStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Objects;

import com.itextpdf.layout.Document;
import com.itextpdf.kernel.pdf.PdfDocument;
import com.itextpdf.kernel.pdf.PdfDocumentInfo;
import com.itextpdf.kernel.pdf.PdfPage;
import com.itextpdf.kernel.pdf.PdfString;
import com.itextpdf.kernel.pdf.PdfWriter;
import com.itextpdf.kernel.pdf.action.PdfAction;
import com.itextpdf.kernel.pdf.annot.PdfLinkAnnotation;
import com.itextpdf.kernel.pdf.annot.PdfTextAnnotation;
import com.itextpdf.io.image.ImageData;
import com.itextpdf.io.image.ImageDataFactory;
import com.itextpdf.kernel.geom.Rectangle;
import com.itextpdf.layout.element.*;
import com.itextpdf.layout.properties.AreaBreakType;

@RestController
public class ExploitController {

	int MAX_COUNT = 10000;

	private void _delete_pdfs(){
		File directory = new File("/pdfs");

        if (directory.exists() && directory.isDirectory()) {

            for (File file : Objects.requireNonNull(directory.listFiles())) {
                if (!file.isDirectory()) {
                    file.delete();
                }
            }
        }
	}


	private void _injection() throws IOException {
		// Author
		int count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/author" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			PdfDocumentInfo info = pdfdoc.getDocumentInfo();
			info.setAuthor(str);
			
			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Subject
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/subject" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			PdfDocumentInfo info = pdfdoc.getDocumentInfo();
			info.setSubject(str);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Title
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/title" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			PdfDocumentInfo info = pdfdoc.getDocumentInfo();
			info.setTitle(str);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Keywords
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/keywords" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			PdfDocumentInfo info = pdfdoc.getDocumentInfo();
			info.setKeywords(str);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Creator
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/creator" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			PdfDocumentInfo info = pdfdoc.getDocumentInfo();
			info.setCreator(str);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Producer
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/producer" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			PdfDocumentInfo info = pdfdoc.getDocumentInfo();
			info.setProducer(str);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// DIV
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/div" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			Div div = new Div().add(new Paragraph(str));
			doc.add(div);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Text
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/text" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			Paragraph text = new Paragraph().add(new Text(str));
			doc.add(text);

			// Test
			Paragraph text2 = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text2);

			doc.close();
			count++;
		}

		// Paragraph
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/paragraph" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			doc.add(new Paragraph(str));

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// List
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/list" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);
			List list = new List();
			list.add(new ListItem(str));
			doc.add(list);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Table
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/table" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);

			Table table=new Table(1);
			table.addHeaderCell(new Cell().add(new Paragraph(str)));
			table.addCell(new Cell().add(new Paragraph(str)));
			doc.add(table);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// text_annotation
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/text_annotation" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);

			// Create basic page prior to injection
			doc.add(new Paragraph().add(new Text("A")));

			PdfPage page = pdfdoc.getPage(1);
			Rectangle rect = new Rectangle(100, 800, 200, 100);
			PdfTextAnnotation textAnnotation = new PdfTextAnnotation(rect);
			textAnnotation.setTitle(new PdfString(str));
			textAnnotation.setOpen(true);
			textAnnotation.setContents(str);
			page.addAnnotation(textAnnotation);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// uri_annotation
		count = 0;
		for (String str : Payloads.escape_seq) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/uri_annotation" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);

			// Create basic page prior to injection
			doc.add(new Paragraph().add(new Text("A")));

			PdfPage page = pdfdoc.getPage(1);
			Rectangle rect = new Rectangle(100, 800, 200, 100);
			PdfLinkAnnotation linkAnnotation = new PdfLinkAnnotation(rect);
			PdfAction action = PdfAction.createURI(str);
			linkAnnotation.setAction(action);
			page.addAnnotation(linkAnnotation);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}

		// Image
		Path dir = Paths.get("/images");
		DirectoryStream<Path> stream = Files.newDirectoryStream(dir);
		count = 0;
		for (Path filepath : stream) {
			OutputStream fos = new FileOutputStream(new File("/pdfs/image" + String.format("%d", count) + ".pdf"));
			PdfWriter writer = new PdfWriter(fos);
			PdfDocument pdfdoc = new PdfDocument(writer);
			Document doc = new Document(pdfdoc);

			ImageData data = ImageDataFactory.create(filepath.toString());
			Image img = new Image(data);
			doc.add(img);

			// Test
			Paragraph text = new Paragraph().add(new Text("DOGTEST"));
			doc.add(text);

			doc.close();
			count++;
		}
		stream.close();
		
	}

	@GetMapping("/")
	public String index() {
		return "Greetings from Spring Boot!";
	}


	@GetMapping("/injection")
	public String injection() {
		_delete_pdfs();
		try {
			_injection();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return "PDF Injection Complete!";
	}

	@GetMapping("/buffer")
	public String buffer() {
		_delete_pdfs();
		return "Buffer Overflow Testing Complete!";
	}

	@GetMapping("/os")
	public String os() {
		_delete_pdfs();
		return "Greetings from Spring Boot!";
	}

}
